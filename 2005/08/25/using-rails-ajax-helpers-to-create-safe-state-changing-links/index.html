
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <script type="text/javascript" src="//use.typekit.net/wpe2bbi.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <meta charset="utf-8">
  <title>Using Rails AJAX helpers to create safe state-changing links - jlaine.net</title>
  <meta name="author" content="Jarkko Laine">

  
  <meta name="description" content="A few months ago there was a heated discussion going on about Google Web Accelerator prefetching links and at the same time wreaking havoc in web &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jlaine.net/2005/08/25/using-rails-ajax-helpers-to-create-safe-state-changing-links/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/feed/atom.xml" rel="alternate" title="jlaine.net" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="author" href="//plus.google.com/117033765270760829494/">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-84654-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jlaine.net</a></h1>
  
</hgroup>

</header>
  <!--<nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/feed/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jlaine.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>-->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Rails AJAX Helpers to Create Safe State-changing Links</h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-08-25T00:00:00+02:00" pubdate data-updated="true">Aug 25<span>th</span>, 2005</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>A few months ago there was <a href="http://www.loudthinking.com/arc/000454.html">a</a> <a href="http://37signals.com/svn/archives2/google_web_accelerator_hey_not_so_fast_an_alert_for_web_app_designers.php">heated</a> <a href="http://jlaine.net/blog/56/google-web-accelerator-considered-harmful">discussion</a> going on about Google Web Accelerator prefetching links and at the same time wreaking havoc in web apps that used plain <span class="caps">GET</span> links to change the state of an application. A few <a href="http://david.backpackit.com/pub/37983">tricks</a> came up on how one could block <span class="caps">GWA</span> from accessing given pages, but in the end, using <span class="caps">GET</span> requests for operations such as deleting records in your app remained dangerous.</p>
<p>The traditional means to avoid the perils of <span class="caps">GWA</span> and friends are two-fold: either use only form buttons (and thus <span class="caps">POST</span> requests) to commit these mission-critical actions, or link to a confirmation page that does the same. Unfortunately, these solutions are less than optimal. Using dozens of forms in a web page (think &#8220;delete&#8221; links in a product listing) makes the code a bit messy and a plethora of delete buttons doesn&#8217;t make the page look very nice, either. The problem with a confirmation page is that it adds one more step to the process and thus <a href="http://sensible.com/buythebook.html">makes the user think</a> one more time. One part of the beauty of OS X compared to Windows is that it doesn&#8217;t try to intervene in every action I make. I like to adhere to the same standards so I want to leave confirmation pages for situations where I really, <em>really</em> think they are crucial.</p>
<p>If you&#8217;re using <a href="http://www.rubyonrails.com">Ruby on Rails</a> to build your next killer web app, consider yourself lucky. In the following paragraphs, I&#8217;m going to teach you how to use the Ã¼bercool <a href="http://rails.rubyonrails.com/classes/ActionView/Helpers/JavaScriptHelper.html"><span class="caps">AJAX</span> helpers</a> in Rails to create action links that are both slick, accessible and about as safe as you can get in the wild wide web.</p>
<p>OK, let&#8217;s assume you have an app ready that uses the following <code>link_to</code> helper call to destroy an item from your collection of <a href="http://www.sock-monkey.com/sockmonkey.html">sock monkeys</a>:</p>
<macro:code lang="ruby">
<p>&lt;%= link_to &#8220;Delete&#8221;, :controller =&gt; &#8220;monkey&#8221;, <br />
                   :action =&gt; &#8220;delete&#8221;, :id =&gt; monkey.id %&gt;</p>
</macro:code>
<p>This would serve you well, that is, until your uncle Enoch finds an abandoned Google Web Accelerator from the trash bin and your beloved monkeys start evaporating in the thin air. So what&#8217;s to the rescue? <a href="http://rails.rubyonrails.com/classes/ActionView/Helpers/JavaScriptHelper.html#M000395"><code>link_to_remote</code></a>!</p>
<macro:code lang="ruby">
<p>&lt;%= link_to_remote &#8220;Delete&#8221;, <br />
  :url =&gt; {:controller =&gt; &#8220;monkey&#8221;, <br />
           :action =&gt; &#8220;delete&#8221;, <br />
           :id =&gt; monkey.id},<br />
  :update =&gt; &#8220;monkeys&#8221; %&gt;</p>
</macro:code>
<p>Now we&#8217;re talking! You&#8217;re from this day on using <span class="caps">AJAX</span> in your app. Your monkeys are now destroyed without a refresh of a page, and no <span class="caps">GET</span> request is ever made. And as your <code>delete</code> action renders the monkey list when called by <span class="caps">AJAX</span>, the list updates itself as if magically. As simple as that. But wait! Aunt Marge (your unpaid tester) yells something behind her AS/400. She can&#8217;t use your app, nothing happens in her <em>lynx</em> even though she tries to follow the link. Crap. No javascript.</p>
<p>Fortunately <code>link_to_remote</code> has a fallback system:</p>
<macro:code lang="ruby">
<p>&lt;%= link_to_remote &#8220;Delete&#8221;, <br />
  {:url =&gt; {:controller =&gt; &#8220;monkey&#8221;, <br />
           :action =&gt; &#8220;delete&#8221;, <br />
           :id =&gt; monkey.id},<br />
  :update =&gt; &quot;monkeys&quot;},<br />
  {:href =&gt; url_for(:controller =&gt; &#8220;monkey&#8221;,<br />
                    :action =&gt; &#8220;delete&#8221;,<br />
                    :id =&gt; monkey.id)} %&gt;</p>
</macro:code>
<p>Using the <em>href</em> parameter makes <code>link_to_remote</code> to include a (tada!) <em>href</em> attribute in the anchor tag it creates. You can use <code>url_for</code> to create the address for it just like in normal links.</p>
<p>Ok, time for a little retrospective. What does our little link widget really do? In normal case, when the user has a modern browser with javascript enabled, when clicked, it calls the delete action with an <a href="http://developer.apple.com/internet/webcontent/xmlhttpreq.html"><em>XMLHttpRequest</em></a>, and upon success updates the element with id &#8220;monkeys&#8221; in the current page. If javascript is disabled, the browser will follow the traditional href link to the delete page.</p>
<p>Note that both the <span class="caps">AJAX</span> url and the old-fashioned href point to the same action. This is intentional. It gives us the possibility to do pretty powerful things with a tiny little action. We&#8217;ll take a look at that action, <code>MonkeyController::delete</code>, next.</p>
<macro:code lang="ruby">
<p>def delete<br />
  if request.xhr?</p>
<ol>
	<li>&#8230; deletion code here &#8230;<br />
    render :partial =&gt; &#8220;monkey&#8221;, :collection =&gt; @monkeys<br />
  elsif request.post?</li>
	<li>&#8230; deletion code here &#8230;<br />
    redirect_to :action =&gt; &#8220;list&#8221;<br />
  else # we assume this is a get message<br />
    render :action =&gt; &#8220;delete_confirmation&#8221;<br />
  end<br />
end<br />
</macro:code></li>
</ol>
<p>The <code>delete</code> function above handles three kinds of requests. If it&#8217;s called by <span class="caps">AJAX</span> (remember the normal case above?), it deletes the monkey and renders the list of remaining monkeys that will then be displayed in the calling page. If the action is called by a <span class="caps">POST</span> request (we&#8217;ll get into when this happens in just a few seconds), the monkey is also deleted but this time, the browser is redirected to the original monkey list page with an external redirect. In third case, when this action is called by a <span class="caps">GET</span> request, we show the user a confirmation page by rendering them delete_confirmation.rhtml (only the important parts of the template are shown here):</p>
<macro:code lang="ruby">
<p>&lt;%= form_tag :controller =&gt; &#8220;monkey&#8221;,<br />
             :action =&gt; &#8220;delete&#8221; <span>&gt;<br />
&lt;</span>= hidden_field_tag &#8220;id&#8221;, @params[:id] <span>&gt;<br />
&lt;</span>= submit_tag &#8220;Really, please get rid of the monkey&#8221; <span>&gt;<br />
&lt;</span>= end_form_tag %&gt;</p>
</macro:code>
<p>This is the page shown to old-world users with javascript disabled that clicked on the delete link on the monkey list page, resulting in calling the <code>delete</code> action with a <span class="caps">GET</span> request. This page is effectively, as you can see, a form that points to the same old <code>delete</code> method. We need to pass the monkey id in the form and we use the convenient hidden_field_tag helper method for that. Requests from this form page constitute the second case of calling <code>delete</code>, making request.post? return true (because <span class="caps">POST</span> is the default method for form_tag).</p>
<h3>Why is this method cool?</h3>
<p>You can use what kind of text or image links on your pages you ever want to, just like with normal links. That&#8217;s got to be nicer than a battery of submit buttons that look all different in different browsers. Even cooler, you don&#8217;t have to stuff your users through the tunnel of indifferent confirmation pages. Just one click, and away they go!</p>
<p>But that&#8217;s not all, folks! The approach is also accesible. People with text browsers or screen readers (or the paranoid with javascript disabled) will be presented a traditional link followed by (sigh!) a confirmation page, for their own safety.</p>
<h3>Why is this method safe?</h3>
<p>No critical action is made with a <span class="caps">GET</span> request. In the most common case the deletion is made through an XMLHttpRequest, which is a) using <span class="caps">POST</span> method and b) launched by javascript so robots or Accelerators or other villains couldn&#8217;t even invoke it. The fallback method, on the other hand, uses the traditional confirmation page idea, forcing the user to submit a <span class="caps">POST</span> form before the actual deletion is made.</p>
<p>So, here&#8217;ya go! A complete system for deleting monkeys. Well, maybe not complete but you get the idea. And all with just a single controller method. And like with all <span class="caps">AJAX</span> helpers in Rails, it&#8217;s really easy to turn a traditional, link- or form-based approach to full-blown <span class="caps">AJAX</span> goodness in a matter of minutes.</p>
<p><strong>Disclaimer:</strong> The point of this article is not to teach all the goodies of link_to_remote or other <span class="caps">AJAX</span> helpers in Rails. There&#8217;s a lot <a href="http://www.rubyonrails.com/media/video/rails-ajax.mov" title="AJAX on Rails video">better</a> <a href="http://mir.aculo.us/">resources</a> for that and I intentionally left the code barebones simple. You&#8217;d certainly want to give the user some kind of indication that an <span class="caps">AJAX</span> process is underway, for example. Search the Rails <a href="http://wiki.rubyonrails.com/">wiki</a> and <a href="http://rails.rubyonrails.com/"><span class="caps">API</span> docs</a> for more info.</p></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jarkko Laine</span></span>

      








  


<time datetime="2005-08-25T00:00:00+02:00" pubdate data-updated="true">Aug 25<span>th</span>, 2005</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://jlaine.net/2005/08/25/using-rails-ajax-helpers-to-create-safe-state-changing-links/" data-via="" data-counturl="http://jlaine.net/2005/08/25/using-rails-ajax-helpers-to-create-safe-state-changing-links/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2005/08/17/false-insecurity/" title="Previous Post: False insecurity">&laquo; False insecurity</a>
      
      
        <a class="basic-alignment right" href="/2005/09/02/speaking-at-eurooscon/" title="Next Post: Speaking at EuroOSCON">Speaking at EuroOSCON &raquo;</a>
      
    </p>
  </footer>
</article>

</div>


    </div>
  </div>
  <footer role="contentinfo"><ul>
  <li><a href="http://jlaine.net/jarkko">About Jarkko</a></li>
  <li><a href="http://notkea.fi"><strong>NOTKEA.FI</strong> – Notkeita ajatuksia taloudesta, teknologiasta ja elämästä suomeksi</a></li>
</ul>

<p>
  Copyright &copy; 2014 - Jarkko Laine -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '50b05efb613f5d7127000040');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

</body>
</html>
